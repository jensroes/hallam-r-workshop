---
title: 'Handeling and exploring data in the `tidyverse`'
author: "Jens Roeser"
output: 
  ioslides_presentation:
    incremental: false
    transition: slower
    widescreen: true
    css: slides.css
bibliography      : ["../refs/references.bib"]
---

<style>
.forceBreak { -webkit-column-break-after: always; break-after: column; }

slides > slide.backdrop {
  background: white;
}

div.footnotes {
  position: absolute;
  bottom: 0;
  margin-bottom: 15px;
  width: 80%;
  font-size: 0.6em;
}

pre {
  font-size: 15px;
}

</style>



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, eval = TRUE, message = FALSE, comment=NA)
options("kableExtra.html.bsTable" = T, digits = 2)
options(pillar.print_min = 5, pillar.print_max = 6)
library(tidyverse)
library(knitr)
library(kableExtra)
```

## About me: Jens Roeser 

<div style="float: left; width: 65%;">

- early career researchfellow @ psychology department (Nottingham Trent University)
- theory: psycholinguistics; language production / comprehension / acquisition
- methods: Bayesian modelling (talk to me about mixture models); Stan; keystroke logging; eyetracking
- teaching: statistics (R of course); cognitive psychology; language acquisition
- twitter: <https://twitter.com/jens_roeser>

</div>

<div style="float: right; width: 30%;">

```{r fig.align='right', out.width="100%", echo = F}
knitr::include_graphics("../gfx/me.jpg")
```
</div>


## Outline for today

- Data wrangling with `tidyverse` (50%)
- Data viz with `ggplot2` (40%)
- R-Markdown (10%)
- Lots of hands-on exercises


## Why should I care?

Why using R (or code in general) to handle data?

** What do you think? **

## Why should I care?

Why using R (or code in general) to handle data?

- \> 70% to 80% of data analysis is data wrangling
- Open source: R is and always will be free of charge
- Reduce human error
- Reduce manual work
- Reproducibility: publish your code and look at code of other researchers
- Flexibility: different ways of looking at data
- Quickly growing number of available add-ons (packages) for data analysis
- Speed: faster than manually transforming data in spreadsheets
- Processing of *large* data sets is not going to be possible in spreadsheets
- Large community of friendly peer support

## Rules!

- Never change your data manually; document everything in code.
  - Retrospective amendments made easy
  - Documentation / reproducibility
- Organized working environment
  - `.Rproj` with one director per project with sub-directories for scripts, data, plots, etc
  - Short scripts: less code with one clear purpose is always better (test is: does the name of your script suggest a specific or general purpose?)
- Comment your code (`# Ceci n'est pas un comment!`)
- If possible, use `tidyverse` instead of base R.


## Download repository

- Download: [https://github.com/jensroes/hallam-r-workshop](https://github.com/jensroes/hallam-r-workshop)
- Click on: `Code` \> `Download ZIP` \> unzip directory on your machine.
- Open project by double clicking on `hallam-r-workshop.Rproj`
- `wrangling/exercises/`: exercises associated with each topic
- `data/`: scripts read data from here
- `wrangling/slides.Rmd`: these slides in R markdown format (`.html` format provided as well)

## Goals of data wrangling: goals

- Data come in various formats (long, wide) and data type (xlsx, ods, json, csv, sav)
- No format is suitable for every goal
- Fluency in data wrangling gives you a lot of power.
- Make data format suitable to use: e.g. for statistical models (correlations, linear regression), functions, data viz, summary table
- Calculate new variables, filter or combine data
- Reveal information
- Summarise information
- (also creating counterbalanced, randomised stimulus lists)


## `tidyverse` {.columns-2}

Collection of R packages for data science that share:

- common data philosophies
- grammar
- data structures
- best practice
- designed to work together


<p class="forceBreak"></p>

```{r fig.align='right', out.width="75%", echo = F}
knitr::include_graphics("../gfx/tidyverse-logo.png")
```

## `tidyverse` {.columns-2}

```{r eval = F}
# Installs 19 packages
install.packages("tidyverse")
```

```{r eval = F}
# Loads 6 packages
library(tidyverse)
```



<p class="forceBreak"></p>
```{r fig.align='right', out.width="75%", echo = F}
knitr::include_graphics("../gfx/tidyverse-logo.png")
```



## `tidyverse`


```{r fig.align='center', out.width="80%", echo = F}
knitr::include_graphics("../gfx/tidyverse-package-workflow.png")
```


## Tidy data 

```{r fig.align='center', out.width="90%", echo = F}
knitr::include_graphics("../gfx/tidy_1.png")
```

- Each variable must have its own column.
- Each observation must have its own row.
- Each value have its own cell.

## Why?

```{r fig.align='center', out.width="90%", echo = F}
knitr::include_graphics("../gfx/tidy_1.png")
```

- Placing variables in columns takes advantage of R's vectorised nature (faster processing, more compact code).
- Consistent data structure allows easier learning of related tools because they have similar underpinning principles (except similar input structures).


## `tidyverse`: verbs

- Functions that do specific things to our data.

- Must know: `read_csv`, `write_csv`, `glimpse`, `select`, `filter`, `mutate`, `group_by` / `ungroup`, `summarise`, `pivot_wider` / `_longer`, `_join`, `bind_rows` / `_cols`

- Also important: `count`, `pull`, `slice`, `across`, `recode`, `unique`, `n`, `where`, `everything`, `~` and `.`, `map`, `starts_with`, `ends_with`, `contains`, `separate`, `unite`, `transmute`

- There are more but these are the most important ones.



## Example data set: @blomkvist2017reference 

```{r fig.align='center', out.width="80%", echo = F}
knitr::include_graphics("../gfx/plos.png")
```

- Age-related changes in cognitive performance through adolescence and adulthood in a real-world task.

## Real-world task: StarCraft 2 {.columns-2}


```{r fig.align='left', out.width="80%", echo = F}
knitr::include_graphics("../gfx/sc2b.jpeg")
```

- Real-time strategy video game
- Nintendo Wii Balance Board

<p class="forceBreak"></p>

```{r fig.align='right', out.width="80%", echo = F}
knitr::include_graphics("../gfx/sc2.jpeg")
```

```{r fig.align='right', out.width="80%", echo = F}
knitr::include_graphics("../gfx/sc2c.jpeg")
```






## Example data set: @blomkvist2017reference {.columns-2}


```{r}
blomkvist <- read_csv("../data/blomkvist.csv")
glimpse(blomkvist)
```
<p class="forceBreak"></p>

- Average reaction time (`rt`) of dominant (`_d`) or non-dominant (`_nd`) `hand` or `foot` in msecs
- `medicine`: number of drugs used daily
- `pal`: physical activity level: 1 (least) to 4 (most active)


## tbls (tibble) {.columns-2}

- `tidyverse` is operating with tibbles
- Type of data structure
- Easier to read in console

```{r eval = F}
# Imports data as data frame
data_as_frame <- read.csv("path_to_data/data.csv")
# Imports data as tibble
data_as_tibble <- read_csv("path_to_data/data.csv")
```

- `.csv`: comma separated file
- `readr` package: e.g. `read_csv`, `read_delim`, `read_tsv`


<p class="forceBreak"></p>

For other data formats:

- `haven` package: e.g. `read_dta`, `read_sav`, `read_sas`
- `readxl` package: e.g. `read_excel`, `read_xls`, `read_xlsx`


```{r eval = F}
# Summarise data structure in base R
str(data_as_frame)
# Summarise data structure in tidyverse
glimpse(data_as_tibble)
```

Continue with exercise 1


## `tidyverse` functions {.columns-2}

Functions follow the principle

```{r, eval = F}
function_name(data_name, argument)
```

where `argument` specifies which variable / condition etc. the function has to operate on.

<p class="forceBreak"></p>

```{r, eval = F}
# Picking out variables
select(data, variable1) 
# Subsetting data
filter(data, variable > 100) 
# Change / add variables
mutate(data, variable_sqr = variable^2)
# Aggregate data
summarise(data, mean_var = mean(variable)) 
```


## Selecting variables 

Extracts variables you're interested in.

<div style="float: left; width: 40%;">
```{r eval = FALSE}
glimpse(blomkvist)
```

```{r echo = FALSE}
glimpse(blomkvist, width = 40)
```

</div>


## Selecting variables   

Extracts variables you're interested in.

<div style="float: left; width: 40%;">

```{r eval = FALSE}
glimpse(blomkvist)
```

```{r echo = FALSE}
glimpse(blomkvist, width = 40)
```

</div>

<div style="float: right; width: 50%;">
```{r}
select(blomkvist, id, sex, age)
```
</div>


## Selecting variables: select range 

Extracts variables you're interested in.

<div style="float: left; width: 40%;">

```{r eval = FALSE}
glimpse(blomkvist)
```

```{r echo = FALSE}
glimpse(blomkvist, width = 40)
```

</div>

<div style="float: right; width: 50%;">
```{r}
select(blomkvist, id:age)
```
</div>


## Selecting variables: index

Extracts variables you're interested in.

<div style="float: left; width: 40%;">

```{r eval = FALSE}
glimpse(blomkvist)
```

```{r echo = FALSE}
glimpse(blomkvist, width = 40)
```

</div>

<div style="float: right; width: 50%;">

```{r}
select(blomkvist, 1, 2, 3)
```
</div>

## Selecting variables: index range 

Extracts variables you're interested in.

<div style="float: left; width: 40%;">

```{r eval = FALSE}
glimpse(blomkvist)
```

```{r echo = FALSE}
glimpse(blomkvist, width = 40)
```

</div>

<div style="float: right; width: 50%;">

```{r}
select(blomkvist, 1:3)
```
</div>

## Selecting variables: rename

Extracts variables you're interested in.

<div style="float: left; width: 40%;">

```{r eval = FALSE}
glimpse(blomkvist)
```

```{r echo = FALSE}
glimpse(blomkvist, width = 40)
```

</div>

<div style="float: right; width: 50%;">

```{r}
select(blomkvist, id, sex, rt = rt_hand_d)
```
</div>

## Selecting multiple variables

Extracts variables you're interested in.

<div style="float: left; width: 40%;">

```{r eval = FALSE}
glimpse(blomkvist)
```

```{r echo = FALSE}
glimpse(blomkvist, width = 40)
```

</div>

<div style="float: right; width: 50%;">

```{r }
select(blomkvist, id, starts_with("rt_"))
```
</div>

## Selecting multiple variables 

Extracts variables you're interested in.

<div style="float: left; width: 40%;">

```{r eval = FALSE}
glimpse(blomkvist)
```

```{r echo = FALSE}
glimpse(blomkvist, width = 40)
```

</div>

<div style="float: right; width: 50%;">

```{r eval = FALSE}
select(blomkvist, id, ends_with("d"))
```
**???**

</div>


## Selecting multiple variables 

Extracts variables you're interested in.

<div style="float: left; width: 40%;">

```{r eval = FALSE}
glimpse(blomkvist)
```

```{r echo = FALSE}
glimpse(blomkvist, width = 40)
```

</div>

<div style="float: right; width: 50%;">

```{r eval = TRUE}
select(blomkvist, id, ends_with("d"))
```
</div>

## Selecting multiple variables

Extracts variables you're interested in.

<div style="float: left; width: 40%;">

```{r eval = FALSE}
glimpse(blomkvist)
```

```{r echo = FALSE}
glimpse(blomkvist, width = 40)
```

</div>

<div style="float: right; width: 50%;">

```{r eval = FALSE}
select(blomkvist, id, contains("hand"))
```
**???**

</div>


## Selecting multiple variables

Extracts variables you're interested in.

<div style="float: left; width: 40%;">

```{r eval = FALSE}
glimpse(blomkvist)
```

```{r echo = FALSE}
glimpse(blomkvist, width = 40)
```

</div>

<div style="float: right; width: 50%;">

```{r}
select(blomkvist, id, contains("hand"))
```
</div>

## (Un-)selecting multiple variables 

Extracts variables you're interested in.

<div style="float: left; width: 40%;">

```{r eval = FALSE}
glimpse(blomkvist)
```

```{r echo = FALSE}
glimpse(blomkvist, width = 40)
```

</div>

<div style="float: right; width: 50%;">

```{r }
select(blomkvist, -contains("hand"))
```

</div>

## (Un-)selecting multiple variables 

Extracts variables you're interested in.

<div style="float: left; width: 40%;">

```{r eval = FALSE}
glimpse(blomkvist)
```

```{r echo = FALSE}
glimpse(blomkvist, width = 40)
```

</div>

<div style="float: right; width: 50%;">

```{r eval = FALSE}
select(blomkvist, -ends_with("_d"))
```

**???**
</div>

## (Un-)selecting multiple variables 

Extracts variables you're interested in.

<div style="float: left; width: 40%;">

```{r eval = FALSE}
glimpse(blomkvist)
```

```{r echo = FALSE}
glimpse(blomkvist, width = 40)
```

</div>

<div style="float: right; width: 50%;">

```{r}
select(blomkvist, -ends_with("_d"))
```

</div>

## (Un-)selecting multiple variables 

Extracts variables you're interested in.

<div style="float: left; width: 40%;">

```{r eval = FALSE}
glimpse(blomkvist)
```

```{r echo = FALSE}
glimpse(blomkvist, width = 40)
```

</div>

<div style="float: right; width: 50%;">

```{r eval = FALSE}
select(blomkvist, -sex:-smoker)
```

**???**

</div>

## (Un-)selecting multiple variables 

Extracts variables you're interested in.

<div style="float: left; width: 40%;">

```{r eval = FALSE}
glimpse(blomkvist)
```

```{r echo = FALSE}
glimpse(blomkvist, width = 40)
```

</div>

<div style="float: right; width: 50%;">

```{r}
select(blomkvist, -sex:-smoker)
```

</div>


## Selecting multiple variables

Extracts variables you're interested in.

<div style="float: left; width: 40%;">

```{r eval = FALSE}
glimpse(blomkvist)
```

```{r echo = FALSE}
glimpse(blomkvist, width = 40)
```

</div>

<div style="float: right; width: 50%;">

```{r }
select(blomkvist, where(is.character))
```

</div>


## Selecting multiple variables

Extracts variables you're interested in.

<div style="float: left; width: 40%;">

```{r eval = FALSE}
glimpse(blomkvist)
```

```{r echo = FALSE}
glimpse(blomkvist, width = 40)
```

</div>

<div style="float: right; width: 50%;">

```{r eval = FALSE}
select(blomkvist, where(is.numeric))
```

**???**

</div>

## Selecting multiple variables

Extracts variables you're interested in.

<div style="float: left; width: 40%;">

```{r eval = FALSE}
glimpse(blomkvist)
```

```{r echo = FALSE}
glimpse(blomkvist, width = 40)
```

</div>

<div style="float: right; width: 50%;">

```{r}
select(blomkvist, where(is.numeric))
```

Continue with exercise 2

</div>


## Filtering data

Select variables of interest

```{r }
blomkvist_rt <- select(blomkvist, id, smoker, age, rt = rt_hand_d)
```


Subsetting data by selecting rows that meet one condition or more.

```{r eval = F}
filter(data, condition)
```


## Continuous variables {.columns-2}


```{r }
filter(blomkvist_rt, rt >= 708)
```
<p class="forceBreak"></p>

```{r }
filter(blomkvist_rt, rt > 708)
```

## Continuous variables


```{r }
filter(blomkvist_rt, rt > 708, rt < 900)
```

## Continuous variables {.columns-2}

```{r }
filter(blomkvist_rt, rt > 708 | rt < 900)
# which is a logical tautology really
```
<p class="forceBreak"></p>

```{r }
filter(blomkvist_rt, rt < 708 | rt > 900)
```

## Continuous variables {.columns-2}

```{r}
filter(blomkvist_rt, rt > mean(rt, na.rm = TRUE))
```
<p class="forceBreak"></p>

```{r}
mean(blomkvist_rt$age, na.rm = TRUE)
```

## NB. What's `na.rm = TRUE`?

```{r}
# Data with missing values
y <- c(100, 1150, 200, 43, NA, 15)
```

```{r}
mean(y)
```

```{r}
mean(y, na.rm = TRUE)
```

```{r}
sd(y, na.rm = TRUE)
```


## Categorical variables {.columns-2}


```{r }
filter(blomkvist_rt, smoker == "yes")
```

<p class="forceBreak"></p>

```{r }
unique(blomkvist_rt$smoker)
```



## Categorical variables {.columns-2}

```{r }
filter(blomkvist_rt, smoker != "yes")
```

<p class="forceBreak"></p>

```{r }
unique(blomkvist_rt$smoker)
```



## Categorical variables {.columns-2}

```{r }
filter(blomkvist_rt, smoker %in% c("yes", "former"))
```

<p class="forceBreak"></p>

```{r }
filter(blomkvist_rt, !(smoker %in% c("yes", "former")))
```

## Missing data

```{r }
unique(blomkvist_rt$smoker)
```

```{r }
filter(blomkvist_rt, smoker == "NA") # ooops!!!
```

```{r }
filter(blomkvist_rt, smoker == NA) # double ooops!!!
```

## Missing data {.columns-2}

```{r}
filter(blomkvist_rt, is.na(smoker))
```
<p class="forceBreak"></p>

```{r }
filter(blomkvist_rt, !is.na(smoker))
```

Continue with exercise 3



## Mutating data

Adding new variables to the data or changing existing ones.

<div style="float: left; width: 50%;">

```{r}
mutate(blomkvist_rt, rt_2 = rt * rt)
```

</div>

<div style="float: right; width: 40%;">

```{r}
mutate(blomkvist_rt, rt_2 = rt^2)
```

</div>

## Mutating data

```{r}
mutate(blomkvist_rt, log_rt = log(rt))
```


## Mutating data

```{r}
mutate(blomkvist_rt, is_slow = rt > 700)
```




## Mutating data 


```{r}
mutate(blomkvist_rt, mean_rt = mean(rt, na.rm = TRUE))
```





## Mutating data {.columns-2}


```{r}
mutate(blomkvist_rt, mean_rt = mean(rt, na.rm = TRUE),
                     is_slow = rt > mean_rt)
```

<p class="forceBreak"></p>

```{r eval = F}
mutate(blomkvist_rt, # or both in one go
       is_slow = rt > mean(rt, na.rm = TRUE))
```

## Mutating data: `recode()` 


```{r}
mutate(blomkvist_rt, smoker_recoded = recode(smoker, former = "former smoker",
                                                     yes = "smoker",
                                                     no = "non-smoker"))
```


## Mutating data: `cut()`

```{r}
mutate(blomkvist_rt, age_cat = cut(age, 
                                   breaks = 3, 
                                   labels = c("low", "middle", "high")))
```

## Mutating data: `case_when()`

```{r eval = F}
case_when(condition ~ do) # similar to ifelse()
```

```{r}
mutate(blomkvist_rt, age_cat = case_when(age > 70 ~ "high",
                                         age > 40 ~ "middle",
                                         is.na(smoker) ~ "dunno",
                                         TRUE ~ "on the young side"))
```

## Mutating data

Continue with exercise 4


## Grouping data with `group_by()` {.smaller}

Perform an action (function) for each level the grouping variable individually.

```{r}
blomkvist_grouped <- group_by(blomkvist_rt, smoker) # Group by smoker
blomkvist_grouped 
# How many groups and what are they?
```


## Mutate grouped data {.columns-2}

```{r}
mutate(blomkvist_rt, # not grouped
       mean_rt = mean(rt, na.rm = TRUE))
```


<p class="forceBreak"></p>


```{r}
mutate(blomkvist_grouped, # grouped data
       mean_rt = mean(rt, na.rm = TRUE))
# What's the grouping variable?
# What's the difference?
```


## Never forget to *ungroup* your data

otherwise you will keep performing by-group operations, even if you didn't intend to.

<div style="float: left; width: 40%;">

```{r}
blomkvist_grouped # :(
```

</div>

<div style="float: right; width: 50%;">

```{r}
ungroup(blomkvist_grouped) # :)
# Spot the difference!
```

</div>



## Summarise (grouped) data

... using descriptive tools.

<div style="float: left; width: 45%;">

```{r}
summarise(blomkvist_rt, # not grouped
          mean_rt = mean(rt, na.rm = TRUE),
          N = n())
```

</div>

<div style="float: right; width: 45%;">

```{r}
summarise(blomkvist_grouped, # grouped data
          mean_rt = mean(rt, na.rm = TRUE),
          N = n())
```

</div>


## Summarise data

Summarising data using descriptive tools.

<div style="float: left; width: 40%;">

```{r}
summarise(blomkvist_rt, # not grouped
          mean_rt = mean(rt, na.rm = TRUE),
          sd_rt = sd(rt, na.rm = TRUE),
          min_rt = min(rt, na.rm = TRUE),
          max_rt = max(rt, na.rm = TRUE),
          N = n())
```

</div>

<div style="float: right; width: 50%;">

```{r}
summarise(blomkvist_grouped, # grouped data
          mean_rt = mean(rt, na.rm = TRUE),
          sd_rt = sd(rt, na.rm = TRUE),
          min_rt = min(rt, na.rm = TRUE),
          max_rt = max(rt, na.rm = TRUE),
          N = n())
```

</div>


## Grouping data

- Continue with exercise 5


## Mutate data with `across()` {.columns-2 .smaller}

Create a new column.

```{r}
mutate(blomkvist_rt, log_rt = log(rt))
```

<p class="forceBreak"></p>

Replace with transformed variable.

```{r}
mutate(blomkvist_rt, across(rt, log))
```

First argument of `across` will be used as first argument of function (`log`) which is supplied as second argument to `across`.


## Mutate data with `across()` {.smaller}

```{r echo = F}
blomkvist_2 <- blomkvist 
blomkvist <- select(blomkvist, -starts_with("pal_"), -sex, -medicine) %>%
  drop_na()
```


```{r, eval = F}
# Instead of
mutate(blomkvist, rt_hand_d = log(rt_hand_d), 
                  rt_hand_nd = log(rt_hand_nd))
```


```{r}
# Do
mutate(blomkvist, across(c(rt_hand_d, rt_hand_nd), log))
```

## Mutate data with `across()` {.smaller} 

```{r}
mutate(blomkvist, across(where(is.numeric), log))
# Not ideal here: see `id` column
```


## Mutate data with `across()`  {.smaller}

```{r eval = F}
mutate(blomkvist, across(starts_with("rt_"), log))
```

```{r echo = F}
tmp <- mutate(blomkvist, across(starts_with("rt_"), log))
glimpse(tmp)
```


## Mutate data with `across()`  {.smaller}

```{r eval = F}
mutate(blomkvist, across(starts_with("rt_"), log, .names = "log_{.col}"))
```


```{r echo = F}
blomkvist_vars <- mutate(blomkvist, across(starts_with("rt_"), log, .names = "log_{.col}"))
glimpse(blomkvist_vars)
```

## Mutate data with `across()`  {.smaller}

```{r eval = F}
mutate(blomkvist, across(starts_with("rt_"), list(lg = log, sqr = ~.^2), .names = "{.fn}_{.col}"))
```

```{r echo = F}
blomkvist_vars <- mutate(blomkvist, across(starts_with("rt_"), list(lg = log, sqr = ~.^2), .names = "{.fn}_{.col}"))
glimpse(blomkvist_vars)
```


## What is "`~.`"? {.columns-2}

```{r}
mutate(blomkvist_rt, across(rt, round, 0))
```

<p class="forceBreak"></p>

```{r}
mutate(blomkvist_rt, across(rt, ~round(., 0)))
```

## What is "`~.`"? {.columns-2}

- "`~`": we want to make the position of the argument in function explicit.
- "`.`": the location of the argument.
- Always possible but necessary for operator functions (`>`, `==`, `^`, `+`) and when argument is not in first position of supplied function.


<p class="forceBreak"></p>

```{r}
mutate(blomkvist_rt, 
       across(rt, ~round(. , 0)), # optional
       across(age, ~.^2),   # operator
       across(rt, ~paste("RT is", .))) # position
```


## Mutate data with `c_across()` {.smaller}

Apply a function across different columns.

Example: get the mean for of all rts for each participant (row).

```{r}
# Long way
mutate(blomkvist, mean_rt = (rt_hand_d + rt_hand_nd + rt_foot_d + rt_foot_nd)/4)
```


## Mutate data with `c_across()` {.smaller}

```{r eval=F}
# Long way
mutate(blomkvist, mean_rt = (rt_hand_d + rt_hand_nd + rt_foot_d + rt_foot_nd)/4)
```

```{r}
# Still a lot of typing :(
blomkvist_rowwise <- rowwise(blomkvist) # each row / ppt is a group
mutate(blomkvist_rowwise, mean_rt = mean(c_across(c(rt_hand_d, rt_hand_nd, rt_foot_d, rt_foot_nd))))
```


## Mutate data with `c_across()` {.smaller}

```{r eval=F}
# Long way
mutate(blomkvist, mean_rt = (rt_hand_d + rt_hand_nd + rt_foot_d + rt_foot_nd)/4)
```

```{r}
# That's better :)
blomkvist_rowwise <- rowwise(blomkvist) # each row / ppt is a group
mutate(blomkvist_rowwise, mean_rt = mean(c_across(starts_with("rt_"))))
```


## Mutate data with `c_across()` {.smaller}

```{r}
# Without rowwise grouping returns the grand average:
mutate(blomkvist, mean_rt = mean(c_across(starts_with("rt_"))))
# which is not what we want.
```




## Filter data with `across()` 

```{r}
filter(blomkvist, rt_hand_d > 1000, rt_hand_nd > 1000, rt_foot_d > 1000, rt_foot_nd > 100)
```


## Filter data with `across()` 

```{r}
filter(blomkvist, across(starts_with("rt_"), ~ . > 1000 ))
```




## Summarise variables with `across()`

```{r}
summarise(blomkvist, rt_hand_d_mean = mean(rt_hand_d),
                     rt_hand_nd_mean = mean(rt_hand_nd))

```

## Summarise variables with `across()`

```{r}
summarise(blomkvist, across(c(rt_hand_d, rt_hand_nd), mean))
```

## Summarise variables with `across()`

```{r}
summarise(blomkvist, across(starts_with("rt_"), mean))
```

## Summarise variables with `across()`

```{r}
summarise(blomkvist, across(starts_with("rt_"), mean))
```

```{r}
summarise(blomkvist, across(starts_with("rt_"), list(mean = mean, sd = sd)))
```

## Using `across()` to mutate and summarise variables

Open exercise 6 script.


## Pivoting data: tidy data 

```{r fig.align='center', out.width="90%", echo = F}
knitr::include_graphics("../gfx/tidy_1.png")
```

Called, a *long* data format.

## Pivoting data: wide format

```{r }
blomkvist_wide <- select(blomkvist, id, starts_with("rt_"))
blomkvist_wide
```

RT is distributed across 4 columns: useful for certain analyses but isn't tidy.

## Pivoting data to long format | has never been easier {.columns-2}

```{r}
blomkvist_wide
```


<p class="forceBreak"></p>

```{r eval = T}
pivot_longer(blomkvist_wide, cols = starts_with("rt_"))
```


## Pivoting data to long format {.columns-2}

```{r }
pivot_longer(blomkvist_wide, cols = -id) # shorthand
```


<p class="forceBreak"></p>

```{r}
pivot_longer(blomkvist_wide, 
             cols = -id, 
             names_to = "variable", 
             values_to = "rt")
```



## Pivoting data to long format {.columns-2}


```{r}
pivot_longer(blomkvist_wide, 
             cols = -id, 
             names_to = "variable",
             values_to = "rt")
```


<p class="forceBreak"></p>

```{r}
pivot_longer(blomkvist_wide, 
             cols = -id, 
             names_to = c(".value", 
                          "response_by", 
                          "dominant"), 
             names_pattern = "(.+)_(.+)_(.+)")
```


## Pivoting data to long format {.columns-2}


```{r}
# Flexible naming pattern
pivot_longer(blomkvist_wide, 
             cols = -id, 
             names_to = c(".value", 
                          "response_by", 
                          "dominant"), 
             names_pattern = "(.+)_(.+)_(.+)")
```


<p class="forceBreak"></p>


```{r}
# Simplifies to
pivot_longer(blomkvist_wide, 
             cols = -id, 
             names_to = c(".value", 
                          "response_by", 
                          "dominant"), 
             names_sep = "_")
```


## Pivoting data back to wide format 

```{r}
bk_long <- pivot_longer(blomkvist_wide, 
                        cols = -id, 
                        names_to = c(".value", "response_by", "dominant"), 
                        names_sep = "_")
bk_long
```

## Pivoting data back to wide format {.columns-2}

```{r}
bk_long
```


<p class="forceBreak"></p>


```{r}
pivot_wider(bk_long, 
            names_from = response_by, 
            values_from = rt)
```


## Pivoting data back to wide format {.columns-2}

```{r}
bk_long
```

<p class="forceBreak"></p>

```{r}
pivot_wider(bk_long, 
            names_from = c(response_by, dominant), 
            values_from = rt)
```


## Pivoting data back to wide format {.columns-2}

```{r}
bk_long
```

<p class="forceBreak"></p>

```{r}
pivot_wider(bk_long, 
            names_from = c(response_by, dominant), 
            values_from = rt, 
            names_prefix = "rt_")
```



## Pivoting data

Continue with exercise 7

```{r echo = F}
blomkvist <- select(blomkvist_2, -starts_with("pal_"))
```



## Combine data: overview

```{r, eval=F}
# Combine two datasets side-by-side
bind_cols(data_1, data_2)
# Stacking two data sets
bind_rows(data_1, data_2)
# Keep all rows of data_1 and add data_2
left_join(data_1, data_2)
# Keep all rows of data_2 and add data_1
right_join(data_1, data_2)
# Include all rows of both data sets
full_join(data_1, data_2)
# Include data that is present in both data sets
inner_join(data_1, data_2)
```


## Combine data: `bind_cols()` {.columns-2}

```{r}
bk_id_age <- select(blomkvist, id, age)
bk_id_age
```

<p class="forceBreak"></p>

```{r}
bk_med_smoke <- select(blomkvist, medicine, smoker)
bk_med_smoke
```


## Combine data: `bind_cols()`

```{r}
# Combine two datasets side-by-side
bind_cols(bk_id_age, bk_med_smoke)
```


## Combine data: `bind_rows()` 

```{r}
bk_former_smokers <- filter(blomkvist, smoker == "former")
bk_smokers <- filter(blomkvist, smoker == "yes")
```

## Combine data: `bind_rows()` {.smaller}

```{r}
# Stacking two data sets
bk_smoking <- bind_rows(bk_former_smokers, bk_smokers)
```

```{r}
slice_head(bk_smoking, n = 1)
```

```{r}
slice_tail(bk_smoking, n = 1)
```

This also works when columns are not in the same order as long as the names and types match.



## Create two example data sets

```{r}
bk_smoker <- select(blomkvist, smoker, age)
bk_smoker_o40 <- filter(bk_smoker, age > 40)
```

```{r}
bk_sex <- select(blomkvist, sex, age)
bk_sex_u50 <- filter(bk_sex, age < 50)
```

## Create two example data sets {.columns-2}

```{r}
bk_smoker_o40
```

<p class="forceBreak"></p>

```{r}
bk_sex_u50
```


## Combine data: `left_join()` {.columns-2}


```{r}
# Keep all rows of bk_sex_u50
bk_joined <- left_join(bk_sex_u50, 
                       bk_smoker_o40, by = "age")
bk_joined
```

<p class="forceBreak"></p>

```{r}
range(bk_joined$age)
```


## Combine data: `right_join()` {.columns-2}

```{r}
# Keep all rows of bk_smoker_o40
bk_joined <- right_join(bk_sex_u50, 
                        bk_smoker_o40, by = "age")
bk_joined
```

<p class="forceBreak"></p>

```{r}
range(bk_joined$age)
```


## Combine data: `full_join()` {.columns-2}

```{r}
# Include all rows of both data sets
bk_joined <- full_join(bk_sex_u50, 
                       bk_smoker_o40, by = "age")
bk_joined
```

<p class="forceBreak"></p>

```{r}
range(bk_joined$age)
```

## Combine data: `inner_join()` {.columns-2}

```{r}
# Include only info that is present in both data sets
bk_joined <- inner_join(bk_sex_u50, 
                        bk_smoker_o40, by = "age")
bk_joined
```

<p class="forceBreak"></p>

```{r}
range(bk_joined$age)
```

## Combing data

Continue with exercise 8



## The pipe: `%>%` {.columns-2}

- `%>%` moves or "pipes" the result forward into the next function  
- `f(x)` is the same as `x %>% f()`  
- Short-cut: `Ctrl` + `Shift` + `M`

```{r eval = F}
select(data, myvar1, myvar2)
# or
data %>% select(myvar1, myvar2)
```

*assumes first argument is data


<p class="forceBreak"></p>

```{r fig.align='right', out.width="80%", echo = F}
knitr::include_graphics("../gfx/pipe.png")
```


## The pipe: `%>%` {.columns-2}


```{r eval = F}
# Instead of 
data_1 <- first_step(data)
data_2 <- second_step(data_2)
data_3 <- third_step(data_3)
data_4 <- fourth_step(data_4)

# or
first_step(
    second_step(
        third_step(
            fourth_step(data)
            )
          )
        )
```

<p class="forceBreak"></p>

```{r eval = F}
# Just do
data %>% 
  first_step() %>%
  second_step() %>%
  third_step() %>%
  fourth_step()
```


## The pipe: `%>%` {.columns-2}


```{r}
bk <- read_csv("../data/blomkvist.csv")
bk_rts <- select(bk, id, starts_with("rt_"))
bk_rts_flt <- filter(bk_rts, rt_hand_d > 1500)
bk_rts_flt
```

<p class="forceBreak"></p>

```{r}
read_csv("../data/blomkvist.csv") %>% 
  select(id, starts_with("rt_")) %>% 
  filter(rt_hand_d > 1500)
```


## The pipe: `%>%`

Continue with exercise 9


## Recommended reading {.columns-2}

- *R for Data Science* by Wickham and Grolemund
- This link [r4ds.had.co.nz/](https://r4ds.had.co.nz/)

<p class="forceBreak"></p>

```{r fig.align='right', out.width="65%", echo = F}
knitr::include_graphics("../gfx/wickham.jpg")
```


## References



